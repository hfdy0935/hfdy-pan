var Ue=Object.defineProperty;var Se=(l,a,s)=>a in l?Ue(l,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[a]=s;var b=(l,a,s)=>Se(l,typeof a!="symbol"?a+"":a,s);/* empty css              */import{g as re,s as F,a as H,u as ue,_ as Te}from"./index-CdIjDISF.js";import{g as G,a as ce,r as Be,b as Ee,c as Pe,u as V,d as qe,e as $e,f as De,h as ze}from"./useFolderLevelTree-BY3VF7JM.js";import{g as Me}from"./validate-BSUe8xyQ.js";/* empty css              *//* empty css              *//* empty css              */import"./file-CTjv8ooS.js";/* empty css              */import{u as J,a as ie,b as de,c as pe,d as je,m as Z}from"./menuData-BfYzelEX.js";import{aE as m,d as O,c as j,ag as $,ai as He,am as u,o as w,an as B,ao as h,ap as e,aG as c,aq as K,aZ as L,e as U,b5 as ee,b6 as ae,aY as D,aX as E,n as X,b as W,a_ as Re,b7 as fe,b8 as Ne,b9 as Le,ba as Ae,bb as Ve,bc as Qe,b3 as Oe,bd as Ke,be as A,bf as te,T as We,J as Ze,a as q,bg as se,ar as Xe,av as Ye,bh as Ge,aV as Je,bi as ea,bj as aa,bk as ta}from"./arco-design-vue-wpZPvk8Z.js";import{c as Y}from"./calc-CYjR0slx.js";import{_ as sa}from"./logo.vue_vue_type_script_setup_true_lang-GCBf-g6C.js";import{H as oa}from"./index-DeLZq7_u.js";import"./arco-design-vue-icon-S64ufJhU.js";import"./useBreadcrumb-DDMjDaLE.js";const na=l=>re({url:"/updateUserInfo",method:"post",data:l}),la=l=>re({url:"/updateHomePassword",method:"post",data:l});function oe(l){return new Worker("/assets/calcMD5Worker-CUUhYSGC.js",{name:l==null?void 0:l.name})}const{isTree:ra,breadcrumbs:ne}=F(J()),{updateFileItem:ua}=ie(),{updateTreeData:ca}=de(),{uploadFileList:ia}=F(pe()),{updateUserInfo:da}=H(),he=je(()=>{m.success("上传成功"),ra.value?ca():ua(),da()});async function pa(l){const{md5:a}=l,s=l.fileItem.file,n=new FormData;n.append("file",s),n.append("filename",s.name+""),n.append("md5",a),n.append("totalSize",s.size+""),n.append("pid",l.pid),n.append("category",G(s.name)),n.append("mediaType",ce(s.name));try{const i=await Be(n);i.code===200?(l.status="finish",he(),l.uploadedChunkIndexs.push(0)):(l.status="error",m.error(i.message))}catch{l.status="error",m.error("上传失败")}}function me(l){const a=[];let s=0;for(;s<l.size;){const n=l.slice(s,s+Q.CHUNK_SIZE);a.push(new Blob([n],{type:l.type})),s+=Q.CHUNK_SIZE}return a}class fa{constructor(a,s=[]){b(this,"jobs");b(this,"currTask");b(this,"stopFlag");b(this,"executeCount");this.jobs=s,this.currTask=null,this.stopFlag=!1,this.executeCount=0}addTask(a){this.jobs.push(a)}get queue(){return this.jobs}async start(){var s;const a=[];this.currTask=async n=>{var d;if(this.stopFlag)return;this.stopFlag=!1,await n(),this.executeCount+=1;const i=this.jobs.shift();i&&a.push((d=this.currTask)==null?void 0:d.call(this,i))};for(let n=0;n<5;n++){const i=this.jobs.shift();i&&a.push((s=this.currTask)==null?void 0:s.call(this,i))}await Promise.all(a)}stop(){this.stopFlag=!0}}class Q{constructor(a){b(this,"showedTip");b(this,"chunks");b(this,"controller");b(this,"reqQueue");b(this,"item");b(this,"uploadedChunkIndexes");b(this,"options");b(this,"category");b(this,"mediaType");this.showedTip=!1,this.controller=new AbortController,this.item=ia.value[a.index],this.reqQueue=new fa(this.item),this.uploadedChunkIndexes=this.item.uploadedChunkIndexs,this.chunks=me(this.item.fileItem.file),this.options=a,this.category=G(this.item.fileItem.name??""),this.mediaType=ce(this.item.fileItem.name??"")}async prepareReqs(){const{item:a,chunks:s,controller:n}=this,{md5:i,fileItem:d}=a,{file:p}=d;this.chunks.forEach((g,y)=>{if(this.uploadedChunkIndexes.includes(y))return;const v=new FormData;v.append("file",g),v.append("filename",p.name+""),v.append("chunkIndex",y.toString()),v.append("totalChunkNum",s.length+""),v.append("totalSize",p.size+""),v.append("pid",a.pid),v.append("md5",i),v.append("category",this.category),this.reqQueue.addTask((S=y)=>Ee(v,n.signal).then(C=>{if(C.code===200)a.uploadedChunkIndexs.push(S);else{if(this.reqQueue.stop(),a.status==="pause")return;throw!this.showedTip&&m.error(C.message),this.showedTip=!0,new Error(C.message)}return C}).catch(()=>{this.reqQueue.stop(),a.status!=="pause"&&(a.status="error",!this.showedTip&&m.error("上传失败"))}))})}async upload(){await this.prepareReqs(),await this.reqQueue.start(),this.reqQueue.stopFlag||await this.merge()}async merge(){const{item:a,category:s,mediaType:n}=this,i=a.fileItem.file,d=i.name;await Pe({filename:d,pid:ne.value[ne.value.length-1].id,md5:a.md5,totalSize:i.size,totalChunkNum:this.chunks.length,category:s,mediaType:n}),a.status="finish",he()}}b(Q,"CHUNK_SIZE",10*1024*1024);const ha=10;async function ma(l){const a=Array.from({length:ha}).map(()=>new oe),s=[],n=d=>new Promise(async p=>{const g=l.shift();g?(d.postMessage({type:"start",file:await g.arrayBuffer()}),d.onmessage=y=>{p(y.data.md5),s.push(n(d))}):p("")});for(const d of a)s.push(n(d));const i=(await Promise.all(s)).filter(d=>d.length);return i.length===1?i[0]:new Promise(async d=>{const p=new oe;p.postMessage({type:"start",file:await new Blob(i,{type:"text/plain"}).arrayBuffer()}),p.onmessage=g=>{d(g.data.md5)}})}const va={class:"w-56 truncate"},_a={class:"w-64 truncate flex items-center"},wa={class:"flex"},ga=O({__name:"upload-file-card",setup(l){const{isTree:a}=F(J()),{updateTreeData:s}=de(),{uploadFileList:n}=F(pe()),{updateFileItem:i}=ie(),{updateUserInfo:d}=H(),{iconColor:p,Icons:g}=F(V()),{userInfo:y}=F(H()),v=j(()=>({color:p.value,backgroundColor:"transparent"})),S=j(()=>{const t=[];return n.value.map(r=>t.unshift(r)),t}),C=async(t,r)=>{const k=n.value[r],o=me(t.file);k.totalChunks=o.length;const T=await ma(o);k.md5=T,await M(k)},P=t=>t.fileItem.file.size>Q.CHUNK_SIZE,R=$([]);He(n,async t=>{t.forEach(async r=>{R.value.includes(r.fileItem.uid)||(R.value.push(r.fileItem.uid),r.status="parse",await C(r.fileItem,r.index))})},{deep:!0});const z={parse:"正在解析",upload:"正在上传",finish:"上传完成",pause:"暂停上传",error:"上传出错"},I=async t=>{const r=()=>{n.value.splice(t.index,1),n.value.forEach((k,o)=>k.index=o)};if(t.uploadedChunkIndexs.length<t.totalChunks)try{const k=await $e({md5:t.md5,chunkIndexes:[...t.uploadedChunkIndexs],category:G(t.fileItem.name??"")});k.code===200?r():m.error(k.message)}catch{m.error("删除失败")}else r()},f=t=>{t.status="pause";const r=t.uploader;r==null||r.controller.abort(),r==null||r.reqQueue.stop()},M=async t=>{var k;t.status="upload";let r={uploaded:!1,indexes:[]};if(y.value.totalSpace-y.value.usedSpace<(((k=t.fileItem.file)==null?void 0:k.size)??0)){m.error("上传失败，空间不足"),n.value=n.value.filter(o=>o.fileItem.uid!==t.fileItem.uid);return}try{const o=await De(t.md5);o.code===200&&(r=o.data)}catch{}if(r.uploaded)ze(t).then(o=>{o.code===200?(t.uploadedChunkIndexs=[0],t.totalChunks=1,t.status="finish",a.value?s():i(),d(),m.success("上传成功，已启用秒传")):m.error(o.message)}).catch(o=>m.error(o));else if(t.uploadedChunkIndexs=[...new Set([...t.uploadedChunkIndexs,...r.indexes])],P(t)){const o=new Q(t);t.uploader=o,await o.upload()}else await pa(t)},x=()=>{for(let t=n.value.length-1;t>=0;t--)n.value[t].status==="finish"&&n.value.splice(t,1);m.success("清空成功")};return(t,r)=>{const k=u("IconSwap"),o=Re,T=fe,ve=Ne,_e=u("icon-pause-circle"),we=u("icon-play-arrow"),ge=u("icon-refresh"),ke=u("icon-delete"),ye=Le,xe=Ae,Ce=Ve,be=Qe,Ie=Oe,Fe=Ke;return w(),B(Fe,{trigger:"click","unmount-on-close":!1},{content:h(()=>[e(Ie,{title:"文件上传管理",style:{width:"400px","max-width":"100vw","max-height":"600px",overflow:"auto",border:"2px solid #ddd","border-radius":"6px","box-shadow":"0 0 2px #ddd"}},{extra:h(()=>[c(n).length?(w(),B(be,{key:0,content:"清空已上传文件"},{default:h(()=>[(w(),B(K(c(g).deleteCompletely),{class:"cursor-pointer",onClick:x}))]),_:1})):L("",!0)]),default:h(()=>[e(Ce,{bordered:!1,data:c(S)},{item:h(({item:_})=>[e(xe,{style:{width:"360px",padding:"3px"}},{actions:h(()=>[U("div",wa,[ee(e(o,{shape:"round",type:"text"},{icon:h(()=>[_.status==="upload"?(w(),B(_e,{key:0,onClick:N=>f(_)},null,8,["onClick"])):L("",!0),_.status==="pause"?(w(),B(we,{key:1,onClick:N=>M(_)},null,8,["onClick"])):L("",!0)]),_:2},1536),[[ae,["upload","pause"].includes(_.status)]]),ee(e(o,{shape:"round",type:"text",onClick:N=>M(_)},{icon:h(()=>[e(ge)]),_:2},1032,["onClick"]),[[ae,_.status==="error"]]),["pause","finish","error"].includes(_.status)?(w(),B(ye,{key:0,type:"warning",position:"lb",content:"确定要删除吗？",onOk:N=>I(_)},{default:h(()=>[e(o,{shape:"round",type:"text"},{icon:h(()=>[e(ke)]),_:1})]),_:2},1032,["onOk"])):L("",!0)])]),default:h(()=>[e(ve,null,{avatar:h(()=>[(w(),B(K(c(qe)(_.fileItem.name)),{class:"scale-150 max-w-20"}))]),title:h(()=>[U("div",va,D(_.fileItem.name),1)]),description:h(()=>{var N;return[E(" 位置："+D(_.level)+" / ",1),U("div",_a,[E(D(c(Y)(((N=_.fileItem.file)==null?void 0:N.size)??""))+"  ",1),U("span",{class:X(`${_.status==="error"?"text-[red]":_.status==="finish"?"text-[green]":""}`)},D(z[_.status]),3)]),e(T,{percision:2,style:{width:"260px"},percent:+(_.uploadedChunkIndexs.length/_.totalChunks).toFixed(3)},null,8,["percent"])]}),_:2},1024)]),_:2},1024)]),_:1},8,["data"])]),_:1})]),default:h(()=>[e(o,{shape:"circle",size:"large",class:"mr-1",style:W(c(v))},{icon:h(()=>[e(k,{rotate:90,class:"scale-125",size:20})]),_:1},8,["style"])]),_:1})}}}),ka={nickname:[{required:!0,message:"昵称不能为空"}]},ya=l=>{const a=Me(l);return{password:a.password,newPassword:a.password}};function xa(){const l=ue(),a=$(!0),{userInfo:s}=F(H()),{isDark:n,menuIdx:i,subMenuIdx:d,textColor:p,bgColor:g,iconColor:y}=F(V()),{toggleTheme:v}=V(),{clear:S}=H(),C=$("updateUserInfo"),P=$(!1),R=j(()=>({color:p.value,backgroundColor:g.value})),z={class:"scale-125",size:20},I=j(()=>({color:y.value,backgroundColor:"transparent"})),f=$({nickname:s.value.nickName,avatar:{uid:"0",url:s.value.avatar}}),M=()=>{if(!f.value.nickname.trim())return m.warning("昵称不能为空"),!1;const o=new FormData;o.append("nickname",f.value.nickname),o.append("avatar",f.value.avatar.file),na(o).then(T=>{T.code===200?(m.success("修改成功"),s.value.nickName=T.data.nickname,s.value.avatar=T.data.avatar,a.value=!0):m.error(`修改失败，${T.message}`)}).catch(()=>{m.error("修改失败")})},x=$({password:"",newPassword:""}),t=async()=>{if(!x.value.password.trim()||!x.value.newPassword.trim()){m.warning("密码不能为空");return}const o=await la(x.value);o.code===200?(m.success("修改成功，请重新登录"),S(),await l.push("/entry")):m.error(`修改失败，${o.message}`)},r=$(!1),k=async()=>{S(),await l.replace("/entry"),m.success("退出登录成功")};return()=>e(A,null,[e("div",{class:"w-screen flex items-center px-4",style:R.value},[e("div",{class:"flex items-center cursor-pointer select-none",onClick:()=>{i.value=0,d.value=0,l.push("/")}},[e(sa,null,null)]),e("div",{class:"flex-1 flex justify-end items-center"},[e(u("a-button"),{shape:"circle",size:"large",class:"mr-1",style:I.value},{icon:()=>e(A,null,[n.value?e(u("icon-moon"),te(z,{onClick:v}),null):e(u("icon-sun"),te(z,{onClick:v}),null)])}),e(ga,null,null),e(u("a-button"),{shape:"circle",size:"large",class:"mr-2"},{icon:()=>e(A,null,[a.value?e("img",{src:s.value.avatar,alt:"",key:s.value.avatar,onError:()=>a.value=!1},null):e(u("icon-user"),z,null),E(" ")])}),e(u("a-dropdown"),{trigger:"hover"},{default:()=>e(u("a-button"),{type:"outline"},{default:()=>[e("span",{class:"max-w-32 truncate",style:{color:y.value}},[E("欢迎，"),s.value.nickName])]}),content:()=>e("div",{class:"w-28"},[e(u("a-doption"),{class:"w-28 flex justify-center",onClick:()=>{C.value="updateUserInfo",P.value=!0}},{default:()=>[E("修改信息")]}),e(u("a-doption"),{class:"w-28 flex justify-center",onClick:()=>{C.value="updatePassword",P.value=!0}},{default:()=>[E("修改密码")]}),e(u("a-doption"),{class:"w-28 flex justify-center"},{default:()=>[e("div",{onClick:()=>r.value=!0},[E("退出登录")])]})])})]),e(u("a-modal"),{visible:P.value,"onUpdate:visible":o=>P.value=o,closable:!1,"unmount-on-close":!0,title:C.value==="updateUserInfo"?"修改信息":"修改密码",okText:"提交",onOk:C.value==="updateUserInfo"?M:t,onCancel:()=>{x.value.password="",x.value.newPassword=""}},{default:()=>[C.value==="updateUserInfo"&&e(u("a-form"),{model:f.value,rules:ka},{default:()=>[e(u("a-form-item"),{field:"nickname",label:"用户名"},{default:()=>[e(u("a-input"),{modelValue:f.value.nickname,"onUpdate:modelValue":o=>f.value.nickname=o,placeholder:"用户名",allowClear:!0},null)]}),e(u("a-form-item"),{field:"avatar",label:"头像"},{default:()=>[e(u("a-upload"),{"show-file-list":!1,onChange:(o,T)=>{f.value.avatar=T},onProgress:o=>f.value.avatar=o},{"upload-button":()=>{var o;return e("div",{class:`arco-upload-list-item${((o=f.value.avatar)==null?void 0:o.status)==="error"?" arco-upload-list-item-error":""}`},[f.value.avatar.url?e("div",{class:"arco-upload-list-picture custom-upload-avatar"},[e("img",{src:f.value.avatar.url,alt:""},null),e("div",{class:"arco-upload-list-picture-mask"},[e(We,null,null)]),(f.value.avatar.status==="uploading"&&f.value.avatar.percent||!1)&&e(u("a-progress"),{percent:f.value.avatar.percent,type:"circle",size:"mini",style:{position:"absolute",left:"50%",top:"50%",transform:"translateX(-50%) translateY(-50%)"}},null)]):e("div",{class:"arco-upload-picture-card"},[e("div",{class:"arco-upload-picture-card-text"},[e(Ze,null,null),e("div",{style:"margin-top: 10px; font-weight: 600"},[E("Upload")])])])])}})]})]}),C.value==="updatePassword"&&e(u("a-form"),{model:x.value,rules:j(()=>ya(x.value.password)).value},{default:()=>[e(u("a-form-item"),{field:"password",label:"输入旧密码"},{default:()=>[e(u("a-input-password"),{modelValue:x.value.password,"onUpdate:modelValue":o=>x.value.password=o},null)]}),e(u("a-form-item"),{field:"newPassword",label:"确认新密码"},{default:()=>[e(u("a-input-password"),{modelValue:x.value.newPassword,"onUpdate:modelValue":o=>x.value.newPassword=o},null)]})]})]}),e(u("a-modal"),{visible:r.value,"onUpdate:visible":o=>r.value=o,closable:!1,"unmount-on-close":!0,onOk:async()=>{await k(),r.value=!1},onCancel:()=>r.value=!1,"ok-button-props":{status:"danger"}},{default:()=>[e("div",{class:"text-lg"},[E("确定要退出登录吗？")])]})]),e("div",{class:"w-full h-[1px] bg-[#E5E6EB]"},null)])}const Ca=O(xa,{props:[]}),ba={class:"flex"},Ia={class:"w-20"},Fa=["onClick"],Ua={class:"text-md"},Sa={key:0,class:"w-28"},Ta=["onClick"],Ba={class:"ml-3"},Ea={class:"flex flex-col justify-center items-center absolute bottom-10 left-1 text-xs"},le=O({__name:"side-nav",setup(l){const{menuIdx:a,subMenuIdx:s,textColor:n,bgColor:i,isDark:d}=F(V()),{userInfo:p}=F(H()),g=j(()=>p.value.usedSpace/p.value.totalSpace),y=ue(),{isTree:v}=F(J()),S=j(()=>({backgroundColor:i.value,color:n.value})),C=I=>I<.3?"#00B42A":I<.5?oa:I<.8?"#FF7D00":"#F53F3F",P=I=>I.path==="/admin"&&!p.value.isAdmin,R=async(I,f)=>{await y.push(I),s.value=0,a.value=f},z=async(I,f)=>{await y.push(I),s.value=f};return(I,f)=>{var x;const M=fe;return w(),q("aside",{class:"h-full flex flex-col",style:W(c(S))},[U("div",ba,[U("div",Ia,[(w(!0),q(A,null,se(c(Z),(t,r)=>(w(),q("div",{key:t.id,class:X(`${r===c(a)?"text-h-blue":""} h-20 flex flex-col justify-center
                    items-center select-none cursor-pointer hover:text-h-blue transition-all my-4`),onClick:k=>R(t.path,r)},[P(t)?L("",!0):(w(),q(A,{key:0},[(w(),B(K(t.icon),{class:"scale-[2] mb-4"})),U("div",Ua,D(t.name),1)],64))],10,Fa))),128))]),!c(v)&&((x=c(Z)[c(a)].children)!=null&&x.length)?(w(),q("div",Sa,[(w(!0),q(A,null,se(c(Z)[c(a)].children,(t,r)=>(w(),q("div",{key:r,class:X(`h-14 flex justify-center items-center rounded hover:text-h-blue cursor-pointer select-none ${r===c(s)?c(d)?"text-h-blue bg-[#333]":"text-h-blue bg-[#eee]":""}`),onClick:k=>z(t.path,r)},[(w(),B(K(t.icon),{class:"scale-[1.3]"})),U("div",Ba,D(t.name),1)],10,Ta))),128))])):L("",!0)]),U("div",Ea,[e(M,{type:"circle",percent:+c(g).toFixed(2),color:C(c(g)),"stroke-width":4},null,8,["percent","color"]),f[0]||(f[0]=U("span",{class:"my-2"},"已用空间",-1)),E(" "+D(c(Y)(c(p).usedSpace))+"/"+D(c(Y)(c(p).totalSpace)),1)])],4)}}}),Pa={class:"flex w-full h-full"},qa={class:"flex-1 overflow-auto"},$a=O({__name:"content",setup(l){const a=$(!1),{isDark:s,textColor:n,bgColor:i}=F(V());return(d,p)=>{const g=u("icon-double-right"),y=Ge,v=u("router-view");return w(),q("main",Pa,[e(Xe,null,{default:h(()=>[e(le,{class:"hidden lg:flex"})]),_:1}),U("div",{class:"lg:hidden pl-2 top-12",style:W({backgroundColor:c(i),color:c(n)})},[e(g,{class:"scale-150 mt-10 hover:text-h-blue",onClick:p[0]||(p[0]=S=>a.value=!0)})],4),e(y,{width:220,placement:"left",closable:!1,footer:!1,visible:c(a),"onUpdate:visible":p[1]||(p[1]=S=>Ye(a)?a.value=S:null),unmountOnClose:"",drawerStyle:{backgroundColor:c(i),color:c(n),borderRight:c(s)?"1px solid #BFBFBF":""}},{default:h(()=>[e(le)]),_:1},8,["visible","drawerStyle"]),U("section",qa,[e(v)])])}}}),Da=Te($a,[["__scopeId","data-v-27c07171"]]),Ja=O({__name:"index",setup(l){const{bgColor:a}=F(V()),{updateUserInfo:s}=H();return Je(s),(n,i)=>{const d=aa,p=ta,g=ea;return w(),B(g,{style:W([{height:"100vh",position:"relative"},{backgroundColor:c(a)}])},{default:h(()=>[e(d,null,{default:h(()=>[e(c(Ca))]),_:1}),e(p,{class:"overflow-auto"},{default:h(()=>[e(Da)]),_:1})]),_:1},8,["style"])}}});export{Ja as default};
